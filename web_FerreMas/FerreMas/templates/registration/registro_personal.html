{% extends 'web/base.html' %}
{% load static %}

{% block nombrePag %}
<title>Registro Personal</title>
{% endblock %}

{% block contenido %}
<div id="formulario-trabajador" class="form">
  <h3>Crear nuevo trabajador</h3>

  <form id="form-crear-trabajador" onsubmit="event.preventDefault(); crearTrabajador();">
    
    <div class="flex-column">
      <label>Correo electr칩nico</label>
    </div>
    <div class="inputForm">
      <input type="email" id="correo-trabajador" name="correo" class="input" placeholder="correo@empresa.cl" required>
    </div>

    <div class="flex-column">
      <label>Nombre</label>
    </div>
    <div class="inputForm">
      <input type="text" id="nombre-trabajador" name="nombre" class="input" placeholder="Nombre del trabajador" required>
    </div>

    <div class="flex-column">
      <label>Apellido paterno</label>
    </div>
    <div class="inputForm">
      <input type="text" id="apellido-paterno-trabajador" name="apellido_paterno" class="input" placeholder="Apellido paterno" required>
    </div>

    <div class="flex-column">
      <label>Apellido materno</label>
    </div>
    <div class="inputForm">
      <input type="text" id="apellido-materno-trabajador" name="apellido_materno" class="input" placeholder="Apellido materno" required>
    </div>

    <div class="flex-column">
      <label>RUT</label>
    </div>
    <div class="inputForm">
      <input type="text" id="rut-trabajador" name="rut" class="input" placeholder="12.345.678-9" required pattern="\d{7,8}-[\dkK]">
    </div>

    <div class="flex-column">
      <label>Regi칩n de la sucursal donde trabaja</label>
    </div>
    <div class="inputForm">
      <select id="region-sucursal" name="region" class="input" required>
        <option value="">Seleccione una regi칩n</option>
        <!-- Se cargan din치micamente -->
      </select>
    </div>

    <div class="flex-column">
      <label>Comuna de la sucursal donde trabaja</label>
    </div>
    <div class="inputForm">
      <select id="comuna-sucursal" name="comuna" class="input" required>
        <option value="">Seleccione una comuna</option>
      </select>
    </div>

    <div class="flex-column">
      <label>Rol</label>
    </div>
    <div class="inputForm">
      <select id="rol-trabajador" name="rol" class="input" required>
        <option value="admin">Administrador</option>
        <option value="vendedor">Vendedor</option>
        <option value="contador">Contador</option>
        <option value="bodeguero">Bodeguero</option>
      </select>
    </div>

    <div class="flex-column">
      <label>Contrase침a generada autom치ticamente</label>
    </div>
    <div class="inputForm" style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="password-trabajador" name="password" class="input" readonly required>
      <button type="button" onclick="copiarPassword()">游늶 Copiar</button>
    </div>

    <button type="submit" class="button-submit">Crear trabajador</button>
  </form>

  <div id="contenedor-mensaje" class="oculto" style="margin-top: 15px; background: #eef; border: 1px solid #99c; padding: 10px;">
    <div id="mensaje-texto"></div>
  </div>
</div>

<script>
  document.getElementById('rut-trabajador').addEventListener('input', generarPassword);
  document.getElementById('nombre-trabajador').addEventListener('input', generarPassword);
  document.getElementById('apellido-paterno-trabajador').addEventListener('input', generarPassword);

  function generarPassword() {
    const rut = document.getElementById('rut-trabajador').value.trim();
    const nombre = document.getElementById('nombre-trabajador').value.trim().toLowerCase();
    const apellido = document.getElementById('apellido-paterno-trabajador').value.trim().toLowerCase();
    const passInput = document.getElementById('password-trabajador');

    if (rut && nombre && apellido) {
      const rutClean = rut.replace(/\./g, '').replace(/-/g, '');
      const simbolos = ['!', '@', '#', '$', '%'];
      const simbolo = simbolos[Math.floor(Math.random() * simbolos.length)];
      const parte1 = nombre.slice(0, 2);
      const parte2 = apellido.slice(0, 2);
      const parte3 = nombre.slice(2, 4);
      const password = `${parte1}${rutClean.slice(0, 3)}${parte2}${simbolo}${rutClean.slice(-3)}${parte3}`;
      passInput.value = password;
    } else {
      passInput.value = "";
    }
  }

  function copiarPassword() {
    const input = document.getElementById('password-trabajador');
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    mostrarMensaje('Contrase침a copiada al portapapeles');
  }

  function mostrarMensaje(texto) {
    const contenedor = document.getElementById('contenedor-mensaje');
    const mensaje = document.getElementById('mensaje-texto');
    mensaje.textContent = texto;
    contenedor.classList.remove('oculto');
    setTimeout(() => contenedor.classList.add('oculto'), 3000);
  }
</script>
{% endblock %}
